---
apiVersion: v1alpha1
kind: AgentConfig
metadata:
  name: {{ cluster_name }}

rendezvousIP: {{ nodes | selectattr('role', 'equalto', 'master') | map(attribute='ip') | first }}

{% if ntp_servers is defined and ntp_servers | length > 0 %}
additionalNTPSources:
{% for ntp in ntp_servers %}
  - {{ ntp }}
{% endfor %}
{% endif %}

hosts:
{% for node in nodes %}
  - hostname: {{ node.hostname }}
    role: {{ node.role }}
    interfaces:
      - name: enp1s0
        macAddress: {{ node.mac }}
    rootDeviceHints:
      deviceName: {{ node.root_disk | default('/dev/vda') }}
    networkConfig:
      interfaces:
        - name: enp1s0
          type: ethernet
          state: up
          mac-address: {{ node.mac }}
          ipv4:
            enabled: true
            address:
              - ip: {{ node.ip }}
                prefix-length: {{ machine_network | ansible.utils.ipaddr('prefix') }}
            dhcp: false
      dns-resolver:
        config:
          server:
{% for dns in dns_servers %}
            - {{ dns }}
{% endfor %}
      routes:
        config:
          - destination: 0.0.0.0/0
            next-hop-address: {{ gateway }}
            next-hop-interface: enp1s0
            table-id: 254
{% endfor %}
